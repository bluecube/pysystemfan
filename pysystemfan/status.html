<html>
<head>
<title>PySystemFan status</title>
<script type="text/javascript">

function update() {
    var req = new XMLHttpRequest(); // a new request
    req.open("GET", "/status.json", true);
    req.send();
    req.onreadystatechange = function() {
        if (req.readyState != 4 || req.status != 200)
            return;
        display(JSON.parse(req.responseText));
    }

    setTimeout(update, interval * 1000);
}

function display(json_data) {
    document.getElementById("last_update").innerHTML = new Date(json_data.last_update * 1000);

    thermometer_rows = display_items(json_data.thermometers);
    document.getElementById("thermometers").innerHTML = thermometer_rows;

    fans_rows = display_items(json_data.fans);
    document.getElementById("fans").innerHTML = fans_rows;

    model_rows = display_model(json_data.model);
    document.getElementById("model").innerHTML = model_rows;

    interval = json_data.update_interval;
    document.getElementById("update_interval").innerHTML = interval + " s";
}

function display_items(items) {
    var keys = {};
    for (var item in items) {
        for (var key in items[item])
        {
            keys[key] = true;
        }
    }

    delete keys["name"]; // name is handled separately

    var ret = "<tr><th>&nbsp;</th>";
    for (var item in items)
        ret += "<th>" + items[item].name + "</th>";
    ret += "</tr>";

    for (var key in keys) {
        ret += "<tr><th>" + key + "</th>";
        for (var item in items)
        {
            if (key in items[item])
                ret += "<td>" + display_value(key, items[item][key]) + "</td>";
            else
                ret += "<td>&nbsp;</td>";
        }
        ret += "</tr>";
    }

    return ret;
}

function display_model(data) {
    var ret = ""
    for (var key in data) {
        ret += "<tr><th>" + key + "</th><td>";
        if (key == "parameter_estimate")
            ret += matrix(data[key]);
        else
            ret += display_value(key, data[key]);
        ret += "</td></tr>";
    }
    return ret;
}

function display_value(name, value) {
    if (value === null)
        return "&nbsp;";
    else if (name.indexOf("temperature") > -1)
        return temperature_graph(value);
    else if (value.constructor == Number)
        return value.toFixed(2);
    else
        return value;
}

function temperature_graph(value) {
    return bar_graph(value, 15, 55, value.toFixed(1) + "Â°C");
}

function bar_graph(value, min, max, text) {
    var percentage = 100 * (value - min) / (max - min);
    if (percentage < 0)
        percentage = 0;
    else if (percentage > 100)
        percentage = 100;
    percentage = 100 - percentage;
    return '<div class="bar_outer"><div class="bar_inner" style="height: ' + percentage.toFixed(1) +
           '%">&nbsp;</div></div>' + text;
}

function matrix(value) {
    var ret = "<table class=\"matrix\">";
    for (var i = 0; i < value.length; ++i) {
        ret += "<tr>";
        var row = value[i];
        if (!(row instanceof Array))
            row = [row];
        for (var j = 0; j < row.length; ++j)
            ret += "<td>" + row[j].toExponential(2) + "</td>";
        ret += "</tr>";
    }
    ret += "</table>";
    return ret;
}

var interval = 10; // Interval between updates in seconds.

function init() {
    update();
}

</script>

<style type="text/css">
.bar_outer {
    background-color: blue;
    border: 1px solid black;
    height: 10em;
    width: 2em;
    display: table-cell;
    vertical-align: bottom;
    display: block;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: 0.5em;
}
.bar_inner {
    background-color: gray;
}
table {
    border-collapse: collapse;
}
td, th {
    text-align: center;
    min-width: 5em;
    padding: 0.5em;
}
td {
    border: 1px solid gray;
}
th {
    border: 1px solid black;
    background-color: gray;
}
table.matrix td {
    border: none;
    padding: 0.1px;
}
</style>

</head>
<body onload="init();">

<h1>PySystemFan status</h1>

<p>Last update: <span id="last_update"></span></p>
<p>Update interval: <span id="update_interval"></span></p>

<h2>Thermometers</h2>
<table id="thermometers">
</table>

<h2>Fans</h2>
<table id="fans">
</table>

<h2>Model</h2>
<table id="model">
</table>

<p><a href="status.json">JSON version</a></p>

</body>
</html>
