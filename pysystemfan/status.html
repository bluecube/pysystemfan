<html>
<head>
<title>PySystemFan status</title>
<script type="text/javascript">

min_temperature = 15;
max_temperature = 55;

function update() {
    json_request("status.json", display);

    if (document.getElementById("show_history").checked) {
        json_request("history.json", display_history);
    }

    setTimeout(update, interval * 1000);
}

function json_request(url, callback) {
    var req = new XMLHttpRequest(); // a new request
    req.open("GET", url, true);
    req.send();
    req.onreadystatechange = function() {
        if (req.readyState != 4 || req.status != 200)
            return;
        callback(JSON.parse(req.responseText));
    }
}

function display(json_data) {
    document.getElementById("last_update").innerHTML = new Date(json_data.last_update * 1000);

    thermometer_rows = display_items(json_data.thermometers);
    document.getElementById("thermometers").innerHTML = thermometer_rows;

    fans_rows = display_items(json_data.fans);
    document.getElementById("fans").innerHTML = fans_rows;

    model_rows = display_model(json_data.model);
    document.getElementById("model").innerHTML = model_rows;

    interval = json_data.update_interval;
    document.getElementById("update_interval").innerHTML = interval + " s";
}

function display_items(items) {
    var keys = {};
    for (var item in items) {
        for (var key in items[item])
        {
            keys[key] = true;
        }
    }

    delete keys["name"]; // name is handled separately

    var ret = "<tr><th>&nbsp;</th>";
    for (var item in items)
        ret += "<th>" + items[item].name + "</th>";
    ret += "</tr>";

    for (var key in keys) {
        ret += "<tr><th>" + key + "</th>";
        for (var item in items)
        {
            if (key in items[item])
                ret += "<td>" + display_value(key, items[item][key]) + "</td>";
            else
                ret += "<td>&nbsp;</td>";
        }
        ret += "</tr>";
    }

    return ret;
}

function display_model(data) {
    var ret = ""
    for (var key in data) {
        ret += "<tr><th>" + key + "</th><td>";
        if (key == "parameter_estimate")
            ret += matrix(data[key]);
        else
            ret += display_value(key, data[key]);
        ret += "</td></tr>";
    }
    return ret;
}

function display_value(name, value) {
    if (value === null)
        return "&nbsp;";
    else if (name.indexOf("temperature") > -1)
        return temperature_graph(value);
    else if (value.constructor == Number)
        return value.toFixed(2);
    else
        return value;
}

function temperature_graph(value) {
    return bar_graph(value,
                     min_temperature, max_temperature,
                     value.toFixed(1) + "Â°C");
}

function bar_graph(value, min, max, text) {
    var percentage = 100 * (value - min) / (max - min);
    if (percentage < 0)
        percentage = 0;
    else if (percentage > 100)
        percentage = 100;
    percentage = 100 - percentage;
    return '<div class="bar_outer"><div class="bar_inner" style="height: ' + percentage.toFixed(1) +
           '%">&nbsp;</div></div>' + text;
}

function matrix(value) {
    var ret = "<table class=\"matrix\">";
    for (var i = 0; i < value.length; ++i) {
        ret += "<tr>";
        var row = value[i];
        if (!(row instanceof Array))
            row = [row];
        for (var j = 0; j < row.length; ++j)
            ret += "<td>" + row[j].toExponential(2) + "</td>";
        ret += "</tr>";
    }
    ret += "</table>";
    return ret;
}

function display_history(data) {
    var section = document.getElementById("history_container");
    if (document.getElementById("show_history").checked) {
        section.style.display = "block";
    } else {
        section.style.display = "none";
        return;
    }

    var variables = {};

    for (var i in data.labels) {
        if (data.labels[i].length == 1)
            continue;

        variables[data.labels[i][1]] = true;
    }

    var html = "";
    for (var variable in variables) {
        html += "<tr><th>" + variable + "</th><td><canvas id=\"history_canvas_" +
                 variable + "\">Canvas not supported</canvas></td></tr>";
    }
    html += "<tr><th>legend</th><td>";
    html += "&nbsp;";
    html += "</td></tr>";

    first_time = data.values[0][0];
    last_time = data.values[data.values.length - 1][0];

    document.getElementById("history").innerHTML = html;

    for (var variable in variables) {
        var ctx = document.getElementById("history_canvas_" + variable).getContext("2d");
        if (variable = "temperature")
            canvas_axes(ctx, first_time, last_time, min_temperature, max_temperature, 20);
        else
            canvas_axes(ctx, first_time, last_time, 0, 1, 20);

        for (var value_index in data.labels) {
            if (data.labels[value_index].length == 1)
                continue;

            if (data.labels[value_index][1] != variable)
                continue;

            var started = false;

            ctx.beginPath();
            for (var i in data.values) {
                var t = data.values[i][0];
                var v = data.values[i][value_index];

                if (v == undefined)
                    continue;

                if (started)
                    ctx.lineTo(t, v);
                else {
                    ctx.moveTo(t, v);
                    started = true;
                }
            }
            ctx.stroke();
        }

    }

    /*
    legend_rows = display_legend(data.history_legend);
    document.getElementById("model").innerHTML = model_rows;
    document.getElementById("history_legend").set_

    */
}

function log10round(val) {
    return Math.exp(Math.LN10 * Math.round(Math.log(val) / Math.LN10));
}

function canvas_axes(ctx, tmin, tmax, ymin, ymax, pxgridsize) {
    var w = ctx.canvas.clientWidth;
    var h = ctx.canvas.clientHeight;

    tminDate = new Date(tmin * 1000);
    tmaxDate = new Date(tmax * 1000);

    dy = ymax - ymin;
    // ygrid * h / pxgridsize ~~ dy
    // We want a grid line approximately every pxgridsize pixels

    ygrid = log10round((ymax - ymin) * pxgridsize / h);
    y_low_grid = Math.floor(ymin / ygrid);
    y_high_grid = Math.ceil(ymax / ygrid);

    ay = -h / ((y_high_grid - y_low_grid) * ygrid);
    by = -ymax * ay;

    at = w / (tmax - tmin);
    bt = -tmin * at;

    ctx.setTransform(at, 0, 0, ay, bt, by);
    ctx.lineWidth = 1/ay;

    for (var i = y_low_grid; i <= y_high_grid; ++i) {
        ctx.fillRect(tmin, i * ygrid, tmax - tmin, 1/ay);
    }
}

function show_history_changed(checkbox) {
    var section = document.getElementById("history_container");
    if (checkbox.checked) {
        json_request("history.json", display_history);
    } else {
        section.style.display = "none";
        document.getElementById("history").innerHTML = "";
    }
}

var interval = 10; // Interval between updates in seconds.

function init() {
    update();
}

</script>

<style type="text/css">
.bar_outer {
    background-color: blue;
    border: 1px solid black;
    height: 10em;
    width: 2em;
    display: table-cell;
    vertical-align: bottom;
    display: block;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: 0.5em;
}
.bar_inner {
    background-color: gray;
}
table {
    border-collapse: collapse;
}
td, th {
    text-align: center;
    min-width: 5em;
    padding: 0.5em;
}
td {
    border: 1px solid gray;
}
th {
    border: 1px solid black;
    background-color: gray;
}
table.matrix td {
    border: none;
    padding: 0.1px;
}
</style>

</head>
<body onload="init();">

<h1>PySystemFan status</h1>

<p>Last update: <span id="last_update"></span></p>
<p>Update interval: <span id="update_interval"></span></p>

<h2>Thermometers</h2>
<table id="thermometers">
</table>

<h2>Fans</h2>
<table id="fans">
</table>

<h2>Model</h2>
<table id="model">
</table>

<p><input type="checkbox" id="show_history" onchange="show_history_changed(this)" /><label for="show_history">Show history</label></p>

<div id="history_container" style="display: none">
<h2>History</h2>

<table id="history">
</table>

</div>

<p><a href="status.json">status.json</a>, <a href="history.json">history.json</a></p>

</body>
</html>
